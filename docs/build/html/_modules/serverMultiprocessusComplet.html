
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="fr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>serverMultiprocessusComplet &#8212; documentation Software Deployment 0</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Code source de serverMultiprocessusComplet</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: ISO-8859-1</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Ce programme permet de faire tourner un serveur de discussion instantanée.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">traceback</span>
 
<span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1">#               GESTION DES CLIENTS</span>
<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="login"><a class="viewcode-back" href="../serverMultiprocessusComplet.html#serverMultiprocessusComplet.login">[docs]</a><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="n">allConnexions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Permet l&#39;identification du client lors d&#39;une connexion</span>
<span class="sd">    </span>
<span class="sd">    :param con: connexion du client</span>
<span class="sd">    :type con: socket</span>
<span class="sd">    :param allConnexions: ensemble des couples (socket,identifiant) des clients actuellement connectés</span>
<span class="sd">    :type allConnexions: queue</span>
<span class="sd">    :return: identifiant du client connecté</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span> 
    	<span class="n">wrongID</span><span class="o">=</span><span class="kc">True</span>
    	<span class="k">while</span><span class="p">(</span><span class="n">wrongID</span><span class="p">)</span> <span class="p">:</span> 
            <span class="n">con</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s2">&quot;Veuillez entrer votre nom d&#39;utilisateur : &quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="n">ID</span><span class="o">=</span><span class="n">con</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="n">ID</span><span class="o">=</span><span class="n">ID</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">ID</span><span class="o">=</span><span class="n">ID</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#retire le \n en fin du nom d&#39;utilisateur</span>
            <span class="nb">print</span> <span class="p">(</span><span class="n">ID</span><span class="p">)</span>
        
            <span class="k">if</span><span class="p">(</span><span class="n">is_known</span><span class="p">(</span><span class="s2">&quot;run/passwd.txt&quot;</span><span class="p">,</span><span class="n">ID</span><span class="p">))</span> <span class="p">:</span>
                <span class="n">wrongPasswd</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">while</span><span class="p">(</span><span class="n">wrongPasswd</span><span class="p">):</span> 
                    <span class="n">con</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s2">&quot;Veuillez entrer votre mot de passe : &quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span> 
                    <span class="n">passwd</span><span class="o">=</span><span class="n">con</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                    <span class="n">passwd</span><span class="o">=</span><span class="n">passwd</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> 
                    <span class="k">if</span><span class="p">(</span><span class="n">check_passwd</span><span class="p">(</span><span class="s2">&quot;run/passwd.txt&quot;</span><span class="p">,</span><span class="n">ID</span><span class="p">,</span><span class="n">passwd</span><span class="p">))</span> <span class="p">:</span> 
                        <span class="n">wrongPasswd</span><span class="o">=</span><span class="kc">False</span>
                        <span class="n">wrongID</span><span class="o">=</span><span class="kc">False</span>
                      
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">con</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s2">&quot;Mot de passe incorrect, voulez-vous réessayer(yes/no) ?</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>  
                        <span class="n">ans</span><span class="o">=</span><span class="n">con</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                        <span class="n">ans</span><span class="o">=</span><span class="n">ans</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ans</span><span class="o">==</span><span class="s2">&quot;no</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                            <span class="n">wrongPasswd</span><span class="o">=</span><span class="kc">False</span>
                	
            <span class="k">else</span><span class="p">:</span>
                <span class="n">con</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s2">&quot;ID inconnu, êtes vous sûr de vouloir créer un compte ? (yes/no) ?</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span> 
                <span class="n">ans</span><span class="o">=</span><span class="n">con</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                <span class="n">ans</span><span class="o">=</span><span class="n">ans</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">ans</span><span class="o">==</span><span class="s2">&quot;yes</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="n">wrongID</span><span class="o">=</span><span class="kc">False</span>
                    <span class="n">con</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s2">&quot;Veuillez saisir un mot de passe pour créer votre compte : &quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span> 
                    <span class="n">passwd</span><span class="o">=</span><span class="n">con</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                    <span class="n">passwd</span><span class="o">=</span><span class="n">passwd</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> 
                    <span class="n">add_user</span><span class="p">(</span><span class="s2">&quot;run/passwd.txt&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">passwd</span><span class="p">)</span>
                    <span class="n">allConnexions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
                    <span class="n">con</span><span class="o">.</span><span class="n">sendall</span><span class="p">((</span><span class="s2">&quot;Vous êtes connecté en tant que : &quot;</span><span class="o">+</span><span class="n">ID</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
                 							
    <span class="k">except</span><span class="p">:</span>
        <span class="n">con</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s2">&quot;Erreur d&#39;authentification, la connexion n&#39;a pas pu être correctement établie&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">raise</span>
        

    <span class="n">send_history</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="s2">&quot;run/history.txt&quot;</span><span class="p">,</span><span class="n">find_last_msg</span><span class="p">(</span><span class="s2">&quot;run/history.txt&quot;</span><span class="p">,</span><span class="n">ID</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ID</span></div>

<span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1">#               GESTION DES FICHIERS</span>
<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="is_known"><a class="viewcode-back" href="../serverMultiprocessusComplet.html#serverMultiprocessusComplet.is_known">[docs]</a><span class="k">def</span> <span class="nf">is_known</span><span class="p">(</span><span class="n">fpassword</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parcours le fichier fpassword pour vérifier si l&#39;identifiant est déjà contenu</span>
<span class="sd">  </span>
<span class="sd">    :param fpassword: nom du fichier à parcourir</span>
<span class="sd">    :type fpassword: str</span>
<span class="sd">    :param ID: Identifiant de l&#39;utilisateur</span>
<span class="sd">    :type ID: str</span>
<span class="sd">    :return: True si l&#39;identifiant a été trouvé, False sinon</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    </span>
<span class="sd">    .. doctest::</span>
<span class="sd">    	&gt;&gt;&gt; import math</span>
<span class="sd">    	&gt;&gt;&gt; print(&quot;2&quot;)</span>
<span class="sd">    	&gt;&gt;&gt; print(math.sqrt(2))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span><span class="o">=</span><span class="kc">False</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpassword</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">l</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">ID</span><span class="p">)]</span><span class="o">==</span><span class="n">ID</span><span class="p">:</span> 
                <span class="n">res</span><span class="o">=</span><span class="kc">True</span>
    <span class="k">return</span> <span class="n">res</span></div>
  
<div class="viewcode-block" id="file_len"><a class="viewcode-back" href="../serverMultiprocessusComplet.html#serverMultiprocessusComplet.file_len">[docs]</a><span class="k">def</span> <span class="nf">file_len</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parcours le fichier fname pour compter le nombre de lignes</span>
<span class="sd">    </span>
<span class="sd">    :param fname: nom du fichier à parcourir</span>
<span class="sd">    :type fname: str</span>
<span class="sd">    :return: nombre de lignes du fichier</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span><span class="o">=-</span><span class="mi">1</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Impossible de compter les lignes de &quot;</span><span class="o">+</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot;: fichier inaccessible&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="rm_first_lines"><a class="viewcode-back" href="../serverMultiprocessusComplet.html#serverMultiprocessusComplet.rm_first_lines">[docs]</a><span class="k">def</span> <span class="nf">rm_first_lines</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">toRemove</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Supprime les &#39;toRemove&#39; premières lignes du fichier fname</span>
<span class="sd">    </span>
<span class="sd">    :param fname: nom du fichier à parcourir</span>
<span class="sd">    :type fname: str</span>
<span class="sd">    :param toRemove: nombre de lignes à supprimer</span>
<span class="sd">    :type toRemove: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tmpFile</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot;.tmp&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="n">toRemove</span><span class="p">:</span>
                    <span class="n">tmpFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">tmpFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot;.tmp&quot;</span><span class="p">,</span><span class="n">fname</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Impossible de supprimer les premières lignes de &quot;</span><span class="o">+</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot;: fichier inaccessible&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="find_last_msg"><a class="viewcode-back" href="../serverMultiprocessusComplet.html#serverMultiprocessusComplet.find_last_msg">[docs]</a><span class="k">def</span> <span class="nf">find_last_msg</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parcours le fichier fname pour trouver le dernier message envoyé par ID</span>
<span class="sd">    </span>
<span class="sd">    :param fname: nom du fichier à parcourir</span>
<span class="sd">    :type fname: str    </span>
<span class="sd">    :param ID: nom de l&#39;utilisateur dont on recherche le dernier message</span>
<span class="sd">    :type fname: str</span>
<span class="sd">    :return: Numéro de ligne du dernier message envoyé par l&#39;utilisateur</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">last</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">l</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">ID</span><span class="p">)]</span><span class="o">==</span><span class="n">ID</span><span class="p">:</span>
                    <span class="n">last</span><span class="o">=</span><span class="n">i</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Impossible de trouver le dernier message dans &quot;</span><span class="o">+</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot;: fichier inaccessible&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">last</span></div>

<div class="viewcode-block" id="check_passwd"><a class="viewcode-back" href="../serverMultiprocessusComplet.html#serverMultiprocessusComplet.check_passwd">[docs]</a><span class="k">def</span> <span class="nf">check_passwd</span><span class="p">(</span><span class="n">fpasswd</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">passwd</span><span class="p">):</span> 
	<span class="sd">&quot;&quot;&quot;Parcours le fichier fpasswd et regarde si le passwd correspond au mot de passe de l&#39;utilisateur ID</span>
<span class="sd">	</span>
<span class="sd">	:param fpasswd: nom du fichier à parcourir</span>
<span class="sd">	:type fpasswd: str</span>
<span class="sd">	:param ID: nom de l&#39;utilisateur dont on check le mot de passe</span>
<span class="sd">	:type ID: str</span>
<span class="sd">	:return: True si le mot de passe est le bon, false sinon</span>
<span class="sd">	:rtype: bool</span>
<span class="sd">&quot;&quot;&quot;</span> 
	<span class="n">res</span><span class="o">=</span><span class="kc">False</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpasswd</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span> 
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">l</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">ID</span><span class="p">)]</span><span class="o">==</span><span class="n">ID</span><span class="p">:</span> 
				<span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">:]</span><span class="o">==</span><span class="n">passwd</span> <span class="p">:</span> 
					<span class="n">res</span> <span class="o">=</span> <span class="kc">True</span> 
	<span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="add_user"><a class="viewcode-back" href="../serverMultiprocessusComplet.html#serverMultiprocessusComplet.add_user">[docs]</a><span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">fpasswd</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">passwd</span><span class="p">):</span> 
	<span class="sd">&quot;&quot;&quot;Ajoute un utilisateur et son mot de passe dans le fichier fpasswd</span>
<span class="sd">	</span>
<span class="sd">	:param fpasswd: nom du fichier à parcourir</span>
<span class="sd">	:type fpasswd: str </span>
<span class="sd">	:param ID: nom de l&#39;utilisateur à ajouter </span>
<span class="sd">	:type ID: str </span>
<span class="sd">	:param passwd: mot de passe de l&#39;utilisateur à ajouter </span>
<span class="sd">	:type passwd: str 	</span>
<span class="sd">&quot;&quot;&quot;</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpasswd</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span> 
		<span class="n">conc</span><span class="o">=</span><span class="n">ID</span><span class="o">+</span><span class="s1">&#39;    &#39;</span><span class="o">+</span><span class="n">passwd</span>
		<span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">conc</span><span class="p">)</span></div>
		
<span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1">#               ENVOI DE MESSAGES</span>
<span class="c1">#------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="send_history"><a class="viewcode-back" href="../serverMultiprocessusComplet.html#serverMultiprocessusComplet.send_history">[docs]</a><span class="k">def</span> <span class="nf">send_history</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">startLine</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Envoie les lignes du fichier fname sur la socket con</span>
<span class="sd">    </span>
<span class="sd">    :param con: client à qui envoyer les lignes du fichier</span>
<span class="sd">    :type con: Socket</span>
<span class="sd">    :param fname: nom du fichier dont on envoie les lignes</span>
<span class="sd">    :type fname: str</span>
<span class="sd">    :param startLine: numéro de ligne à partir duquel on commence à lire le fichier</span>
<span class="sd">    :type startLine: int&quot;&quot;&quot;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="n">startLine</span><span class="p">:</span>
                    <span class="n">con</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Impossible d&#39;écrire d&#39;envoyer l&#39;historique au client, celui-ci ne pourra pas voir les anciencs messages.&quot;</span><span class="p">)</span></div>
    
    
<div class="viewcode-block" id="send_message"><a class="viewcode-back" href="../serverMultiprocessusComplet.html#serverMultiprocessusComplet.send_message">[docs]</a><span class="k">def</span> <span class="nf">send_message</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span><span class="n">senderID</span><span class="p">,</span><span class="n">message</span><span class="p">,</span><span class="n">allConnexions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retransmet le message reçu en provenance de sender à tous les autres clients connectés.</span>
<span class="sd">    </span>
<span class="sd">    :param sender: émetteur du message</span>
<span class="sd">    :type sender: socket</span>
<span class="sd">    :param senderID: identifiant de l&#39;émetteur du message</span>
<span class="sd">    :type senderID: str</span>
<span class="sd">    :param message: message (encodé) envoyé par sender</span>
<span class="sd">    :type message: str</span>
<span class="sd">    :param allConnexions: ensemble des couples (socket,identifiant) des clients actuellement connectés</span>
<span class="sd">    :type allConnexions: queue</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1">#Récupération de l&#39;ensemble des clients connectés</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Récupération de la liste des clients&quot;</span><span class="p">)</span>
                    
    <span class="c1">#Retransmission du message à tous les autres clients</span>
    <span class="n">toSend</span><span class="o">=</span><span class="n">senderID</span><span class="o">+</span><span class="s2">&quot;: &quot;</span><span class="o">+</span><span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Retransmission du message&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">connexion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allConnexions</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">connexion</span><span class="o">.</span><span class="n">getpeername</span><span class="p">()</span> <span class="o">!=</span> <span class="n">sender</span><span class="o">.</span><span class="n">getpeername</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;émetteur:&quot;</span><span class="p">,</span><span class="n">sender</span><span class="o">.</span><span class="n">getpeername</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;destinataire:&quot;</span><span class="p">,</span><span class="n">connexion</span><span class="o">.</span><span class="n">getpeername</span><span class="p">())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connexion</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">toSend</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;données envoyées: &quot;</span><span class="p">,</span><span class="n">toSend</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;erreur de connexion avec &quot;</span><span class="p">,</span><span class="n">connexion</span><span class="o">.</span><span class="n">getpeername</span><span class="p">())</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fermeture de la connexion...&quot;</span><span class="p">)</span>
                <span class="n">connexion</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">allConnexions</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;connexion fermée&quot;</span><span class="p">)</span>

    <span class="c1">#Sauvegarde du message dans l&#39;historique</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">history</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;run/history.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">history</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">toSend</span><span class="p">)</span>
        <span class="n">history</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">toRemove</span><span class="o">=</span><span class="n">file_len</span><span class="p">(</span><span class="s2">&quot;run/history.txt&quot;</span><span class="p">)</span><span class="o">-</span><span class="mi">100</span>
        <span class="k">if</span> <span class="n">toRemove</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">rm_first_lines</span><span class="p">(</span><span class="s2">&quot;run/history.txt&quot;</span><span class="p">,</span><span class="n">toRemove</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Impossible d&#39;écrire dans le fichier history.txt, l&#39;historique ne sera pas mis à jour&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="handle_com"><a class="viewcode-back" href="../serverMultiprocessusComplet.html#serverMultiprocessusComplet.handle_com">[docs]</a><span class="k">def</span> <span class="nf">handle_com</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span><span class="n">allConnexions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Permet au serveur de communiquer avec un client</span>
<span class="sd">    </span>
<span class="sd">    :param con: connexion du client</span>
<span class="sd">    :type con: socket</span>
<span class="sd">    :param addr: adresse du client sous forme d&#39;un couple (adresse IP, numéro de port)</span>
<span class="sd">    :type addr: tuple (str,int)</span>
<span class="sd">    :param allConnexions: ensemble des couples (socket,identifiant) des clients actuellement connectés</span>
<span class="sd">    :type allConnexions: queue</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connexion &quot;</span><span class="p">,</span><span class="n">con</span><span class="p">,</span><span class="s2">&quot; à  l&#39;adresse &quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
        <span class="n">conID</span><span class="o">=</span><span class="n">login</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="n">allConnexions</span><span class="p">)</span>
        <span class="n">connected</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">while</span> <span class="n">connected</span><span class="p">:</span>            
            <span class="c1">#Attente de l&#39;envoi d&#39;un message par le client</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Client déconnecté&quot;</span><span class="p">)</span>
                <span class="n">connected</span><span class="o">=</span><span class="kc">False</span>
                
                <span class="c1">#Retire le client de la liste des clients connectés</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">connexion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allConnexions</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">con</span><span class="o">.</span><span class="n">getpeername</span><span class="p">()</span><span class="o">==</span><span class="n">connexion</span><span class="o">.</span><span class="n">getpeername</span><span class="p">():</span>
                        <span class="n">allConnexions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">getpeername</span><span class="p">(),</span><span class="s2">&quot; retirée de la liste&quot;</span><span class="p">)</span>                      
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Données reçues &quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>         
                <span class="n">send_message</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="n">conID</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">allConnexions</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Données envoyées&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Erreur inattendue:&quot;</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span>  <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_tb</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fermeture de la connexion &quot;</span><span class="p">,</span><span class="n">con</span><span class="o">.</span><span class="n">getpeername</span><span class="p">())</span>
        <span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connexion fermée&quot;</span><span class="p">)</span></div>
      
<span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1">#               MAIN</span>
<span class="c1">#------------------------------------------------------------------------------</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1">#Création si besoin des fichiers nécessaires au fonctionnement</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">)</span>
    <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;run/passwd.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;run/history.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c1">#définition du port d&#39;écoute (par défaut 8888)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aucun numéro de port spécifié, par défaut, 8888 sera utilisé.&quot;</span><span class="p">)</span>
        <span class="n">portNumber</span><span class="o">=</span><span class="mi">8888</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">portNumber</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mySocket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">mySocket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">mySocket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">portNumber</span><span class="p">))</span>
        <span class="n">mySocket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ecoute du port &quot;</span><span class="p">,</span><span class="n">portNumber</span> <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;En attente de connexion&quot;</span><span class="p">)</span>
        <span class="n">allConnexions</span><span class="o">=</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">con</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">mySocket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Client connecté&quot;</span><span class="p">)</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">handle_com</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">allConnexions</span><span class="p">))</span>
            <span class="n">process</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processus &quot;</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interruption clavier&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fermeture des processus:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">active_children</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fermeture du processus &quot;</span><span class="p">,</span> <span class="n">process</span><span class="p">)</span>
            <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>            
        <span class="n">mySocket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FIN&quot;</span><span class="p">)</span> 
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Code du module</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Recherche rapide</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Olivia Pierre.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>